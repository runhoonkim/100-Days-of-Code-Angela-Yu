import requests
import smtplib
import re
from dotenv import load_dotenv
load_dotenv()
import os

STOCK_API_KEY = os.getenv("STOCK_API_KEY")
NEWS_API_KEY = os.getenv("NEWS_API_KEY")
GMAIL_PASSWORD = os.getenv("GMAIL_PASSWORD")
GMAIL_FROM = os.getenv("GMAIL_FROM")
GMAIL_TO = os.getenv("GMAIL_TO")

STOCK = "TSLA"
STOCK_URL = "https://www.alphavantage.co/query"
NEWS_URL = "https://newsapi.org/v2/everything"
COMPANY_NAME = "Tesla Inc"

date_list = []
percent_change = 0
## STEP 1: Use https://www.alphavantage.co
# When STOCK price increase/decreases by 5% between yesterday and the day before yesterday then print("Get News").

def price_change_over_5percent():
    global date_list, percent_change

    params={
        "function": "TIME_SERIES_DAILY",
        "symbol": STOCK,
        "outputsize": "compact",
        "apikey": STOCK_API_KEY,
    }

    stock_response = requests.get(url=STOCK_URL, params=params)
    stock_response.raise_for_status()
    stock_data = stock_response.json()
    date_list = list(stock_data['Time Series (Daily)'])[:2]
    close_price_list = [float(stock_data['Time Series (Daily)'][date]['4. close']) for date in date_list]
    percent_change = round((close_price_list[0] - close_price_list[1]/ close_price_list[0]) * 100, 2)
    if abs(percent_change) > 5:
        return True
    else:
        return False

## STEP 2: Use https://newsapi.org
# Instead of printing ("Get News"), actually get the first 3 news pieces for the COMPANY_NAME. 
def get_news():
    params={
        "q": COMPANY_NAME,
        "sortBy": "publishedAt",
        "language": "en",
        "searchIn": 'title,content,description',
        "apikey": NEWS_API_KEY,
    }
    news_response = requests.get(url=NEWS_URL, params=params)
    news_response.raise_for_status()
    news_list = news_response.json()['articles'][:3]
    return news_list


## STEP 3: Use https://www.twilio.com
# Send a seperate message with the percentage change and each article's title and description to your phone number. 
def send_email():
    with smtplib.SMTP('smtp.gmail.com', 587) as connection:
        connection.starttls()
        connection.login(user=GMAIL_FROM, password=GMAIL_PASSWORD)

        # Add an up or down arrow according to the sign of percent_change
        if percent_change >= 0:
            percent_change_str = f'ðŸ”º{percent_change}%'
        else:
            percent_change_str = f'ðŸ”»{percent_change}%'

        for news in get_news():
            delimiters = r'[.\r\n]+'
            connection.sendmail(
                from_addr=GMAIL_FROM,
                to_addrs=GMAIL_TO,
                msg=(
                    f"Subject:{COMPANY_NAME} Price Change Alert\n\n{STOCK}: {percent_change_str}\n\nHeadline: {news['title']}\n\n"
                    f"Brief: {re.split(delimiters, news['content'])[0]}."
                ).encode("utf-8"),
            )

if price_change_over_5percent():
    send_email()
